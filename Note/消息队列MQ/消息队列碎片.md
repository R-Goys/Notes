# Kafka

## 1. Kafka 的顺序写机制？

kafka 的消息都是通过顺序写来持久化的，不需要涉及到复杂的索引，缺点只有无法插入更新这些操作，但是对于一个专注于高吞吐的消息队列来说，这就够了。

与此同时，kafka 的顺序写又恰好天然构成了消息的偏移量，便于消费者精确控制消费进度。

除此之外，Kafka 也不是直接写入磁盘的，而是配合操作系统的 PageCache 机制来异步写入的。当然，读取也是一样，可以直接从 PageCache 中读取。然而，PageCache 在操作系统挂掉，或者断电的时候注定会有一定的不可靠，所以 Kafka 也提供了一个是否异步写入磁盘的选项，可以自己控制写入策略。

## 2. 零拷贝？

零拷贝是通过 `sendfile()` 系统调用将文件里的内容直接发送到 socket 中，即直接将文件数据发送到网络。那么没有零拷贝会发生什么？首先，我们需要 `read` 文件中的数据，然后通过 `write` 写入到 socket 里面，涉及到两次系统调用，同时，我们将磁盘读到内存中还涉及到 DMA 内存拷贝，从内存到网卡，也涉及到 DMA 内存拷贝，最终，传统的方法就会有 4 次内存拷贝的操作。

而有了 `sendfile` 我们就只需要两次内存拷贝，第一次，从磁盘拷贝数据到内存，第二次，将内存中的数据拷贝到网卡，仅此而已，不会涉及到内核到用户空间的内存拷贝，并且只会涉及到一次系统调用，从而提高了性能。

## 3. Kafka 的分层机制


