## 多级缓存的数据一致性

常见的多级缓存模式为 **本地缓存->分布式缓存->数据库**，对于数据库和分布式缓存的同步策略只需要写后删除即可。而本地缓存需要通过消息队列通知其他节点将这个缓存删除，当然，我们也可以通过 CDC 监听 binlog 来实现 Redis 缓存删除（原因是实现可靠的删除）。

当然 mq 是可能丢消息的，我们也不可能为了消息不丢就做个 outbox，我们还可以给本地缓存指定一个相对比较小的 ttl，防止 mq 消息丢失导致脏数据一直滞留。

即便是这样，也有可能会有不一致的情况，比如一个请求发现本地和分布式缓存都没有数据，然后进入到数据库读取数据，打算回填缓存，此时，另一个请求将新数据写入数据库，然后出发写后删除策略，发给消息队列，此时执行了删除策略，随后，回填了缓存，此时就会产生不一致，所以有一个策略叫做延迟双删策略，通过这个策略可以更大程度保证一致性。

除此之外，还可以使用版本号的策略，通过 mq 广播版本号，让每个节点都同时删除过期的缓存，这样，即便不需要延迟双删也能够防止读到旧数据，当然，对于本地里面没有的 cache，可能意味着我们需要保存多余的数据，我们可以为版本号设置一个合理的过期时间，来保证版本更新之前不会有未执行完的请求，这也是延迟双删所干的事情。